<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>ActDev - Active travel provision and potential in planned and proposed development sites.</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-title" content="ActDev" />

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
	<meta name="msapplication-TileColor" content="#90be6d">
	<meta name="theme-color" content="#ffffff">

	<!-- Fonts -->
	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link
		href="https://fonts.googleapis.com/css2?family=Arimo:wght@400;500;600;700&family=Rubik:wght@300;400;500;600;700&display=swap"
		rel="stylesheet">

	<script src="/js/lib/js-cookie/js.cookie.js"></script>

	<!-- Vex dialogs; see: https://github.hubspot.com/vex/ -->
	<script src="/js/lib/vex-4.1.0/dist/js/vex.combined.min.js"></script>
	<link rel="stylesheet" href="/js/lib/vex-4.1.0/dist/css/vex.css" />
	<link rel="stylesheet" href="/js/lib/vex-4.1.0/dist/css/vex-theme-plain.css" />

	<script src="/js/lib/jquery/jquery.min.js"></script>

	<!-- Chart.js -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

	<!-- Fontawesome icons -->
	<script src="/js/lib/fontawesome/fontawesome-kit-7bd5544b77.js"></script>

	<!-- Parse CSV -->
	<script src="/js/lib/PapaParse/papaparse.min.js"></script>

	<script src="/.config.js"></script>
	<link rel="stylesheet" type="text/css" href="/css/style.css" />

<body>
	<main>
		<section class="national-level-zoom">
			<div class="text-section">

				<img src="/images/beta.svg" width="50" height="50" id="beta" title="Public beta - some features are not yet live" />
				<h1 class="site-title">ACTDEV</h1>
				<h2 class="site-description">Active travel in new developments</h2>
				<h3 class="blurb">This website provides evidence on active travel provision and potential in and around planned and proposed development sites.</h3>
				<h3 class="blurb">Explore the sites weâ€™ve studied.</h3>
				<form id="scenario">
					<div class="ios-segmented-control">
						<span class="selection"></span>
						<div class="option">
							<input type="radio" id="current" name="current-scenario" value="current" checked>
							<label for="current"><span>Current</span></label>
						</div>
						<div class="option">
							<input type="radio" id="goactive" name="current-scenario" value="goactive">
							<label for="goactive"><span>Go Active</span></label>
						</div>
					</div>
				</form>
				<p>A range of factors influence ease of access by walking and cycling. Distance to key destinations such as workplaces is relevant, but equally important is the type of roads that must be followed and the presence or absence of good quality walking and cycling infrastructure.</p>
				<p>For case study sites, we have investigated measures affecting modal choice. These include the ratio of journey times/distances to local destinations by car as compared to by bicycle, the busyness of the roads, and the circuity of the routes. We have also studied access to public transport nodes such as rail stations.</p>
				<ul class="links">
					<li><a href="/about/">Our methodology <i class="fa fa-chevron-right"></i></a></li>
					<li><a href="/report/">Academic report <i class="fa fa-chevron-right"></i></a></li>
				</ul>
				<section class="photos">
					<img src="/images/assets/cut-through1.png" />
					<img src="/images/assets/cut-through2.png" />
					<img src="/images/assets/cut-through3.png" />
				</section>
				<section class="footer">
					<img src="/images/assets/leeds.png" />
					<img src="/images/assets/cyclestreets.png" />
				</section>

			</div>


			<div class="graph-half">
				<div class="section-title">
					<h2>Site data</h2>
					<hr />
				</div>
				<div class="graph-container">
					<canvas id="nationalDataChart" width="800" height="600"></canvas>
				</div>
			</div>
		</section>

	</main>


</body>

<!-- Chart script -->
<script>
	var _nationalSiteChart = false;
	var _nationalDataObject = false; // Store the parsed CSV

	// Main function
	var initialise = function () 
	{
		// Listen to scenario being changed
		listenForScenarioChange ();

		// Get the data and add the first bar chart
		getNationalData ();
	};


	// Listener for toggling of the current/goactive segmented control
	var listenForScenarioChange = function () 
	{
		// Trigger when the segmented control changes
		$('#scenario').change (function () {
			updateChartData ();
		});
	};


	// Get the site-level data
	var getNationalData = function () 
	{
		var nationalStatsUrl = 'https://raw.githubusercontent.com/cyipt/actdev-ui/final-ui-chart/small-site-stats.csv';
		var nationalStatsGoActive =
			'https://raw.githubusercontent.com/cyipt/actdev-ui/final-ui-chart/small-site-stats-goactive.csv'

		// Stream and parse the CSV file
		Papa.parse(nationalStatsUrl, {
			header: true,
			download: true,
			skipEmptyLines: true,
			complete: function (fields) {

				// Unpack the parsed data object
				_nationalDataObject = fields.data;

				// Stream and parse the CSV file
				Papa.parse (nationalStatsGoActive, {
					header: true,
					download: true,
					complete: function (fields) {

						// Unpack the parsed data object
						_nationalDataObjectGoActive = fields.data;

						// Add the bar chart
						addBarChart ();
					}
				});

			}
		});


	};


	// Returns current or goactive
	var getCurrentScenario = function () 
	{
		return $('input[name=current-scenario]:checked', '#scenario').val ();
	};

	var addBarChart = function () 
	{
		var goActiveBool = (getCurrentScenario() == 'goactive');
		insertChartIntoCanvas(generateBarChartDataObject (goActiveBool), generateBarChartOptionsObject(
			'Site accesibility chart'));
	};


	// Generate bar chart data
	var generateBarChartDataObject = function (goActive = false) 
	{
		var labels = _nationalDataObject.map (siteData => siteData.site_name);

		var datasets;
		if (goActive) {
			datasets = [{
				label: 'Walk',
				backgroundColor: '#457b9d',
				data: _nationalDataObjectGoActive.map (siteData => Math.round(Number.parseFloat(siteData
					.walk_active)))
			}, {
				label: 'Bike',
				backgroundColor: '#90be6d',
				data: _nationalDataObjectGoActive.map (siteData => Math.round(Number.parseFloat(siteData
					.cycle_active)))
			}, {
				label: 'Car',
				backgroundColor: '#fe5f55',
				data: _nationalDataObjectGoActive.map (siteData => Math.round(Number.parseFloat(siteData
					.drive_active)))
			}, {
				label: 'Other',
				backgroundColor: '#ffd166',
				data: _nationalDataObjectGoActive.map (siteData => Math.round(Number.parseFloat(siteData
					.other_active)))
			}];
		} else {
			datasets = [{
				label: 'Walk',
				backgroundColor: '#457b9d',
				data: _nationalDataObject.map (siteData => Math.round(Number.parseFloat(siteData.walk_base)))
			}, {
				label: 'Bike',
				backgroundColor: '#90be6d',
				data: _nationalDataObject.map (siteData => Math.round(Number.parseFloat(siteData.cycle_base)))
			}, {
				label: 'Car',
				backgroundColor: '#fe5f55',
				data: _nationalDataObject.map (siteData => Math.round(Number.parseFloat(siteData.drive_base)))
			}, {
				label: 'Other',
				backgroundColor: '#ffd166',
				data: _nationalDataObject.map (siteData => Math.round(Number.parseFloat(siteData.other_base)))
			}];
		}

		var data = {
			labels: labels,
			datasets: datasets
		};

		return data;
	};


	var generateBarChartOptionsObject = function (text) 
	{
		return {
			title: {
				display: false
			},
			legend: {
				position: 'right',
				align: 'middle',
				labels: {
					fontColor: 'white',
					fontSize: 13
				}
			},
			tooltips: {
				mode: 'index',
				intersect: false
			},
			responsive: true,
			scales: {
				xAxes: [{
					stacked: true,
					ticks: {
						fontColor: "#ffffff"
					},
				}],
				yAxes: [{
					stacked: true,
					ticks: {
						fontColor: "#ffffff"
					}
				}],
			},
			indexAxis: 'y',
			onClick: (event, item) => {
				// Chart.js does not include a label click event, so we need to calculate it manually
				// Get the y position of the click
				var clickYPos = event.layerY;

				// Get a dictionary of the x,y positions of the chart labels
				var labelPositions = _nationalSiteChart.scales['y-axis-0']['_labelItems']
				
				// Find closest position from an array with all the y positions
				var closestNumber = getClosestNumber (clickYPos, labelPositions.map (label => label.y))
				
				// Get the corresponding site name
				var closestSite = labelPositions.find ((labelPosition) => (labelPosition.y === closestNumber)).label;

				// Redirect to the site page
				window.location.href = '/' + closestSite + '/';
        	}
		};
	};


	// Function to return the closest number found in a haystack
	var getClosestNumber = function (needle, haystack) 
	{
		return haystack.reduce ((a, b) => {
			let aDiff = Math.abs(a - needle);
			let bDiff = Math.abs(b - needle);

			if (aDiff == bDiff) {
				return a > b ? a : b;
			} else {
				return bDiff < aDiff ? b : a;
			}
   		});
	}


	// Insert graph into canvas
	var insertChartIntoCanvas = function (barChartData, barChartOptions) 
	{
		// If there is no chart element on screen, generate a new one
		if (!_nationalSiteChart) {
			var ctx = document.getElementById ('nationalDataChart').getContext ('2d');
			_nationalSiteChart = new Chart (ctx, {
				type: 'horizontalBar',
				data: barChartData,
				options: barChartOptions
			});
		} else {
			updateChartData ();
		}
	};

	// Update chart
	var updateChartData = function () 
	{
		var goActive = (getCurrentScenario() == 'goactive');
		var newDataSet = generateBarChartDataObject(goActive);

		// Iterate through and replace data
		var currentDataSet = 0;
		newDataSet.datasets.map ((dataSet) => {
			_nationalSiteChart.data.datasets[currentDataSet].data = dataSet.data;
			currentDataSet += 1;
		});

		_nationalSiteChart.update ();
	};

	initialise();
	
</script>


<!-- iOS control script -->
<script>
	// Constants
	const SEGMENTED_CONTROL_BASE_SELECTOR = ".ios-segmented-control";
	const SEGMENTED_CONTROL_INDIVIDUAL_SEGMENT_SELECTOR = ".ios-segmented-control .option input";
	const SEGMENTED_CONTROL_BACKGROUND_PILL_SELECTOR = ".ios-segmented-control .selection";


	// Main
	document.addEventListener ("DOMContentLoaded", setup);

	// Body functions
	function setup() {
		forEachElement(SEGMENTED_CONTROL_BASE_SELECTOR, elem => {
			elem.addEventListener("change", updatePillPosition);
		})
		window.addEventListener("resize",
			updatePillPosition
		); // Prevent pill from detaching from element when window resized. Becuase this is rare I haven't bothered with throttling the event
	}

	function updatePillPosition () {
		forEachElement(SEGMENTED_CONTROL_INDIVIDUAL_SEGMENT_SELECTOR, (elem, index) => {
			if (elem.checked) moveBackgroundPillToElement(elem, index);
		})
	}

	function moveBackgroundPillToElement(elem, index) {
		document.querySelector(SEGMENTED_CONTROL_BACKGROUND_PILL_SELECTOR).style.transform = "translateX(" + (elem
			.offsetWidth * index) + "px)";
	}

	// Helper functions

	function forEachElement(className, fn) {
		Array.from(document.querySelectorAll(className)).forEach(fn);
	}
</script>

</html>
