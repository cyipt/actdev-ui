<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>ActDev - Active travel provision and potential in planned and proposed development sites</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-title" content="ActDev" />

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
	<meta name="msapplication-TileColor" content="#90be6d">
	<meta name="theme-color" content="#ffffff">

	<!-- Fonts -->
	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link
		href="https://fonts.googleapis.com/css2?family=Arimo:wght@400;500;600;700&family=Rubik:wght@300;400;500;600;700&display=swap"
		rel="stylesheet">

	<script src="/js/lib/js-cookie/js.cookie.js"></script>

	<!-- Vex dialogs; see: https://github.hubspot.com/vex/ -->
	<script src="/js/lib/vex-4.1.0/dist/js/vex.combined.min.js"></script>
	<link rel="stylesheet" href="/js/lib/vex-4.1.0/dist/css/vex.css" />
	<link rel="stylesheet" href="/js/lib/vex-4.1.0/dist/css/vex-theme-plain.css" />

	<script src="/js/lib/jquery/jquery.min.js"></script>

	<!-- Chart.js -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

	<!-- Fontawesome icons -->
	<script src="/js/lib/fontawesome/fontawesome-kit-7bd5544b77.js"></script>

	<!-- Parse CSV -->
	<script src="/js/lib/PapaParse/papaparse.min.js"></script>

	<script src="/.config.js"></script>
	<link rel="stylesheet" type="text/css" href="/css/style.css" />

<body>
	<main>
		<section class="national-level-zoom">
			<div class="text-section">

				<img src="/images/beta.svg" width="50" height="50" id="beta" title="Public beta - some features are not yet live" />
				<h1 class="site-title">ActDev</h1>
				<h2 class="site-description">Active travel in new developments</h2>
				<h3 class="blurb">This website provides evidence on active travel provision and potential in and around planned and proposed development sites.</h3>
				<h3 class="blurb">Explore the sites weâ€™ve studied.</h3>
				<form id="scenario">
					<div class="ios-segmented-control">
						<span class="selection"></span>
						<div class="option">
							<input type="radio" id="current" name="current-scenario" value="current" checked>
							<label for="current"><span>Current</span></label>
						</div>
						<div class="option">
							<input type="radio" id="goactive" name="current-scenario" value="goactive">
							<label for="goactive"><span>Go Active</span></label>
						</div>
					</div>
				</form>
				<p>A range of factors influence ease of access by walking and cycling. Distance to key destinations such as workplaces is relevant, but equally important is the type of roads that must be followed and the presence or absence of good quality walking and cycling infrastructure.</p>
				<p>For case study sites, we have investigated measures affecting modal choice. These include the ratio of journey times/distances to local destinations by car as compared to by bicycle, the busyness of the roads, and the circuity of the routes. We have also studied access to public transport nodes such as rail stations.</p>
				<ul class="links">
					<li><a href="/about/">About <i class="fa fa-chevron-right"></i></a></li>
					<li><a href="/report/">Report <i class="fa fa-chevron-right"></i></a></li>
					<li><a href="/manual/">Manual <i class="fa fa-chevron-right"></i></a></li>
					<li><a href="/feedback/" target="_blank" title="[Link opens in a new window]">Feedback <i class="fa fa-chevron-right"></i></a></li>
				</ul>
				<section class="photos">
					<img src="/images/assets/cut-through1.png" alt="New development" />
					<img src="/images/assets/cut-through2.png" alt="New development" />
					<img src="/images/assets/cut-through3.png" alt="New development" />
				</section>
				<section class="footer">
					<img src="/images/assets/leeds.png" alt="University of Leeds" />
					<img src="/images/assets/cyclestreets.png" alt="CycleStreets" />
					<img src="/images/assets/abstreet.png" alt="A/B Street" />
				</section>

			</div>


			<div class="graph-half">
				<div class="section-title">
					<h2>Site data</h2>
					<hr />
				</div>
				<input type="text" id="site-search" name="site-search" placeholder="Search for developments..." />
				<div class="graph-container">
					<canvas id="nationalDataChart" height="300" width="600"></canvas>
				</div>
			</div>
		</section>

	</main>


</body>

<!-- Chart script -->
<script>
	var _nationalSiteChart = false;
	var _nationalDataObject = false; // Store the parsed CSV
	var _currentSearchQuery = '';

	// Main function
	var initialise = function () 
	{
		// Listen to scenario being changed
		listenForScenarioChange ();

		// Listen to the search bar
		listenToSearchBar ();

		// Get the data and add the first bar chart
		getNationalData ();
	};


	// Listener for toggling of the current/goactive segmented control
	var listenForScenarioChange = function () 
	{
		// Trigger when the segmented control changes
		$('#scenario').change (function () {
			updateChartData ();
		});
	};


	// Listen to the search bar and filter
	var listenToSearchBar = function () 
	{
		$('#site-search').on ('keyup', function () {
			_currentSearchQuery = $(this).val ().toLowerCase ();
			const replaceData = true;
			updateChartData (replaceData);
		});
	};


	// Get the site-level data
	var getNationalData = function () 
	{
		var nationalStatsUrl = 'https://raw.githubusercontent.com/cyipt/actdev-ui/final-ui-chart/small-site-stats.csv';
		var nationalStatsGoActive =
			'https://raw.githubusercontent.com/cyipt/actdev-ui/final-ui-chart/small-site-stats-goactive.csv';
		var allSitesCSVInfo = 'https://raw.githubusercontent.com/cyipt/actdev/main/data-small/all-sites.csv';

		// Stream and parse the CSV file
		Papa.parse(nationalStatsUrl, {
			header: true,
			download: true,
			skipEmptyLines: true,
			complete: function (fields) {

				// Unpack the parsed data object
				_nationalDataObject = fields.data;

				// Stream and parse the CSV file
				Papa.parse (nationalStatsGoActive, {
					header: true,
					download: true,
					skipEmptyLines: true,
					complete: function (fields) {

						// Unpack the parsed data object
						_nationalDataObjectGoActive = fields.data;

						// Patch in the pretty name
						Papa.parse (allSitesCSVInfo, {
							header: true,
							download: true,
							skipEmptyLines: true,
							complete: function (fields) {

								// Unpack the parsed data object
								allSitesCsv = fields.data;
								
								// Add the pretty name to the national data object for both scenarios
								var currentSiteIndex = 0;
								var fullName;
								allSitesCsv.map(siteInfo => {
									_nationalDataObject[currentSiteIndex]['full_name'] = siteInfo.full_name;
									_nationalDataObjectGoActive[currentSiteIndex]['full_name'] = siteInfo.full_name;
									currentSiteIndex += 1;
								});

								// Add the bar chart
								addBarChart ();
							}
						});
					}
				});

			}
		});


	};


	// Returns current or goactive
	var getCurrentScenario = function () 
	{
		return $('input[name=current-scenario]:checked', '#scenario').val ();
	};

	
	// Add the bar chart to the DOM
	var addBarChart = function () 
	{
		// Set the chart to be 100vh
		var chart = document.getElementById('nationalDataChart');
		chart.height = window.innerHeight/1.6;
		
		var goActiveBool = (getCurrentScenario() == 'goactive');
		insertChartIntoCanvas(generateBarChartDataObject (goActiveBool), generateBarChartOptionsObject(
			'Site accessibility chart'));
	};


	// Generate bar chart data
	var generateBarChartDataObject = function (goActive = false) 
	{
		var labels = _nationalDataObject.map (siteData => siteData.full_name);

		// Filter this data if we need to search
		var labels = labels.filter (siteName => siteName.toLowerCase ().includes (_currentSearchQuery));

		var datasets;
		if (goActive) {
			var filteredDataObject = _nationalDataObjectGoActive.filter (siteInfo => siteInfo.full_name.toLowerCase ().includes (_currentSearchQuery));
			datasets = [{
				label: 'Walk',
				backgroundColor: '#457b9d',
				data: filteredDataObject.map (siteData => Math.round (Number.parseFloat (siteData.walk_active)))
			}, {
				label: 'Bike',
				backgroundColor: '#90be6d',
				data: filteredDataObject.map (siteData => Math.round (Number.parseFloat (siteData.cycle_active)))
			}, {
				label: 'Car',
				backgroundColor: '#fe5f55',
				data: filteredDataObject.map (siteData => Math.round (Number.parseFloat (siteData.drive_active)))
			}, {
				label: 'Other',
				backgroundColor: '#ffd166',
				data: filteredDataObject.map (siteData => Math.round (Number.parseFloat (siteData.other_active)))
			}];
		} else {
			var filteredDataObject = _nationalDataObject.filter (siteInfo => siteInfo.full_name.toLowerCase ().includes (_currentSearchQuery));
			datasets = [{
				label: 'Walk',
				backgroundColor: '#457b9d',
				data: filteredDataObject.map (siteData => Math.round(Number.parseFloat(siteData.walk_base)))
			}, {
				label: 'Bike',
				backgroundColor: '#90be6d',
				data: filteredDataObject.map (siteData => Math.round(Number.parseFloat(siteData.cycle_base)))
			}, {
				label: 'Car',
				backgroundColor: '#fe5f55',
				data: filteredDataObject.map (siteData => Math.round(Number.parseFloat(siteData.drive_base)))
			}, {
				label: 'Other',
				backgroundColor: '#ffd166',
				data: filteredDataObject.map (siteData => Math.round(Number.parseFloat(siteData.other_base)))
			}];
		}
		
		var data = {
			labels: labels,
			datasets: datasets
		};


		return data;
	};


	var generateBarChartOptionsObject = function (text) 
	{
		var minHeight = 150; 
		var minWidth = 500;
		var width = (window.innerWidth > 0) ? window.innerWidth : screen.width;

		if (width < minWidth || _nationalSiteChart.height < minHeight) {
			var legendPosition = 'top';
		} else {
			var legendPosition = 'right';
		}
		
		return {
			layout: {
				padding: {
					left: 60
				}
			},
			title: {
				display: false
			},
			legend: {
				position: legendPosition,
				align: 'middle',
				labels: {
					fontColor: 'white',
					fontSize: 13
				}
			},
			tooltips: {
				mode: 'index',
				intersect: false
			},
			responsive: true,
			scales: {
				xAxes: [{
					stacked: true,
					ticks: {
						fontColor: "#ffffff"
					},
				}],
				yAxes: [{
					stacked: true,
					ticks: {
						fontColor: "#ffffff",
						/*
						callback: function(value) {
							return value.substr(0, 20) + '...';//truncate
						},
						*/
					}
				}],
			},
			indexAxis: 'y',
			onClick: (event, item) => {
				// Chart.js does not include a label click event, so we need to calculate it manually
				// Get the y position of the click
				var clickYPos = getOffset(event).y;

				// Get a dictionary of the x,y positions of the chart labels
				var labelPositions = _nationalSiteChart.scales['y-axis-0']['_labelItems']
				
				// Find closest position from an array with all the y positions
				var closestNumber = getClosestNumber (clickYPos, labelPositions.map (label => label.y))
				
				// Get the corresponding site name
				var closestSite = labelPositions.find ((labelPosition) => (labelPosition.y === closestNumber)).label;

				// Search to find the code-site-name that matches the prettified label
				var siteCode = _nationalDataObject.find(site => site.full_name === closestSite).site_name;

				// Redirect to the site page
				window.location.href = '/' + siteCode + '/';
        	}
		};
	};

	
	// Function to return the offset of an event click
	var getOffset = function (event) {
		var el = event.target,
			x = 0,
			y = 0;

		while (el && !isNaN(el.offsetLeft) && !isNaN(el.offsetTop)) {
			x += el.offsetLeft - el.scrollLeft;
			y += el.offsetTop - el.scrollTop;
			el = el.offsetParent;
		}

		x = event.clientX - x;
		y = event.clientY - y;

		return {x: x, y: y};
	};


	// Function to return the closest number found in a haystack
	var getClosestNumber = function (needle, haystack) 
	{
		return haystack.reduce ((a, b) => {
			let aDiff = Math.abs(a - needle);
			let bDiff = Math.abs(b - needle);

			if (aDiff == bDiff) {
				return a > b ? a : b;
			} else {
				return bDiff < aDiff ? b : a;
			}
   		});
	}


	// Insert graph into canvas
	var insertChartIntoCanvas = function (barChartData, barChartOptions) 
	{
		// If there is no chart element on screen, generate a new one
		if (!_nationalSiteChart) {
			var ctx = document.getElementById ('nationalDataChart').getContext ('2d');
			_nationalSiteChart = new Chart (ctx, {
				type: 'horizontalBar',
				data: barChartData,
				options: barChartOptions
			});
		} else {
			updateChartData ();
		}
	};

	// Update chart
	var updateChartData = function (replaceData = false) 
	{
		var goActive = (getCurrentScenario() == 'goactive');
		var newDataSet = generateBarChartDataObject(goActive);

		if (replaceData) {
			_nationalSiteChart.data = newDataSet;
			_nationalSiteChart.update (0);
		} else {
			// Iterate through and replace data
			var currentDataSet = 0;
			newDataSet.datasets.map ((dataSet) => {
				_nationalSiteChart.data.datasets[currentDataSet].data = dataSet.data;
				currentDataSet += 1;
			});
			_nationalSiteChart.update ();
		}
	};

	// Initial entry into the script
	initialise();
	
</script>


<!-- iOS control script -->
<script>
	// Constants
	const SEGMENTED_CONTROL_BASE_SELECTOR = ".ios-segmented-control";
	const SEGMENTED_CONTROL_INDIVIDUAL_SEGMENT_SELECTOR = ".ios-segmented-control .option input";
	const SEGMENTED_CONTROL_BACKGROUND_PILL_SELECTOR = ".ios-segmented-control .selection";


	// Main
	document.addEventListener ("DOMContentLoaded", setup);

	// Body functions
	function setup() {
		forEachElement(SEGMENTED_CONTROL_BASE_SELECTOR, elem => {
			elem.addEventListener("change", updatePillPosition);
		})
		window.addEventListener("resize",
			updatePillPosition
		); // Prevent pill from detaching from element when window resized. Becuase this is rare I haven't bothered with throttling the event
	}

	function updatePillPosition () {
		forEachElement(SEGMENTED_CONTROL_INDIVIDUAL_SEGMENT_SELECTOR, (elem, index) => {
			if (elem.checked) moveBackgroundPillToElement(elem, index);
		})
	}

	function moveBackgroundPillToElement(elem, index) {
		document.querySelector(SEGMENTED_CONTROL_BACKGROUND_PILL_SELECTOR).style.transform = "translateX(" + (elem
			.offsetWidth * index) + "px)";
	}

	// Helper functions

	function forEachElement(className, fn) {
		Array.from(document.querySelectorAll(className)).forEach(fn);
	}
</script>

</html>
